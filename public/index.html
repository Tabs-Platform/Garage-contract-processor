<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Garage Contract → Revenue Schedules</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      /* Keep read-only fields fully legible (Safari greys disabled controls) */
select[disabled],
input[readonly] {
  background: #fff !important;
  color: #111827 !important;
  opacity: 1 !important;
}
/* Remove the “disabled” look on borders */
select[disabled] {
  -webkit-text-fill-color: #111827 !important;
  border-color: #e5e7eb !important;
}

      body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 24px; }
      .card { border: 1px solid #e5e7eb; border-radius: 16px; padding: 16px; box-shadow: 0 4px 8px rgba(0,0,0,0.04); margin-bottom: 16px; }
      .grid { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 12px; }
      .grid2 { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; }
      .pill { display:inline-block; padding:2px 8px; border-radius:9999px; background:#eef2ff; color:#3730a3; font-size:12px; font-weight:600; }
      .danger { background:#fee2e2; color:#991b1b; }
      .ok { background:#dcfce7; color:#065f46; }
      .low { background:#fef3c7; color:#92400e; }
      label { display:block; font-size:12px; color:#6b7280; margin-bottom:2px; }
      input, textarea, select { width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px; }
      h1 { font-size: 22px; margin-bottom: 8px; }
      h2 { font-size: 18px; margin: 16px 0 8px; }
      .muted { color:#6b7280; font-size:12px; }
      .btn { padding:10px 14px; border-radius:12px; border: 1px solid #111827; background:#111827; color:white; cursor:pointer; font-weight:600; }
      table { width:100%; border-collapse: collapse; margin-top: 8px; }
      th, td { border:1px solid #e5e7eb; padding:8px; text-align:left; font-size:13px; }
      th { background:#f9fafb; }
      .copy { cursor:pointer; font-size:12px; color:#2563eb; }
      pre { white-space: pre-wrap; }
      .row { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    </style>
  </head>
  <body>
    <h1>Garage Contract → Revenue Schedules</h1>
    <p class="muted">Upload a PDF, get copy-ready schedules (with confidence, evidence, and Garage enums).</p>

    <div class="card">
      <form id="uploadForm">
        <div class="row">
          <input type="file" id="file" name="file" accept="application/pdf" required />
          <div style="display:flex; gap:8px;">
            <select id="model">
              <option value="o3" selected>o3</option>
              <option value="o4-mini">o4-mini</option>
              <option value="gpt-4o-mini">gpt-4o-mini</option>
              <option value="o3-mini">o3-mini</option>
            </select>
            <select id="forceMulti">
              <option value="auto" selected>Auto multi</option>
              <option value="on">Force multi</option>
              <option value="off">Single only</option>
            </select>
            <button class="btn" type="submit">Analyze</button>
          </div>
        </div>
      </form>
      <div id="status" class="muted" style="margin-top:8px;"></div>
    </div>

    <div id="results"></div>

    <script>
      const BILLING_TYPES = ['Flat price','Unit price','Tier flat price','Tier unit price'];
      const FREQ_UNITS = ['None','Day(s)','Week(s)','Semi_month(s)','Month(s)','Year(s)'];
      const $ = (s) => document.querySelector(s);
      const results = $('#results');
      const status = $('#status');

      $('#uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        results.innerHTML = '';
        status.textContent = 'Uploading & extracting…';
        const fd = new FormData();
        fd.append('file', $('#file').files[0]);
        const qs = new URLSearchParams({ model: $('#model').value, forceMulti: $('#forceMulti').value }).toString();
        try {
          const res = await fetch('/api/extract?' + qs, { method: 'POST', body: fd });
          const json = await res.json();
          if (!res.ok) throw new Error(json.error || 'Request failed');
          status.textContent = `Found ${json.schedules.length} schedule(s).`;
          render(json);
        } catch (err) {
          status.textContent = 'Error: ' + err.message;
        }
      });

      function render(data) {
        (data.schedules || []).forEach((s, i) => {
          const conf = s.overall_confidence ?? 0.7;
          const pillClass = conf >= 0.85 ? 'ok' : (conf < 0.6 ? 'danger' : 'low');
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
              <h2>Revenue Schedule ${i+1}</h2>
              <span class="pill ${pillClass}">Confidence ${Math.round(conf*100)}%</span>
            </div>

            <div class="grid">
              ${field('Item name', s.item_name)}
              ${select('Billing type', 'billing_type_'+i, BILLING_TYPES, s.billing_type)}
              ${field('Total price', s.total_price != null ? money(s.total_price) : '')}
            </div>

            <div class="grid" style="margin-top:8px;">
              ${field('Quantity', s.quantity ?? '')}
              ${field('Start date', s.start_date ?? '')}
              ${field('Months of service', s.months_of_service ?? '')}
            </div>

            <div class="grid" style="margin-top:8px;">
              ${field('Calculated end date', s.calculated_end_date ?? '')}
              ${field('Net terms', s.net_terms ?? 30)}
              ${field('Rev-rec category (optional)', s.rev_rec_category ?? '')}
            </div>

            <div class="grid2" style="margin-top:8px;">
              ${field('Every (frequency number)', s.frequency_every ?? 1)}
              ${select('Frequency unit', 'freq_unit_'+i, FREQ_UNITS, s.frequency_unit ?? 'None')}
            </div>

            ${renderOverage(s)}

            <h3 style="margin-top:12px;">Evidence</h3>
            ${(s.evidence||[]).slice(0,6).map(ev=>`<div class="muted">p.${ev.page}: ${escapeHtml(String(ev.snippet||'').substring(0,200))}…</div>`).join('')}

            <div style="margin-top:12px;">
              <span class="copy" onclick='copyPlan(${JSON.stringify(JSON.stringify(toPlan(s))).replace(/'/g,"&#39;")})'>Copy Garage plan</span>
            </div>
          `;
          results.appendChild(card);
        });
      }

      function renderOverage(s) {
        if (s.billing_type === 'Flat price') return '';
        const base = `
          <h3 style="margin-top:12px;">Overage / Usage</h3>
          <div class="grid">
            ${field('Event to track', s.event_to_track ?? '')}
            ${field('Unit label', s.unit_label ?? '')}
            ${field(s.billing_type === 'Unit price' ? 'Price per unit' : 'Price per unit (if applicable)', s.price_per_unit ?? '')}
          </div>
        `;
        if (Array.isArray(s.tiers) && s.tiers.length) {
          const rows = s.tiers.map(t=>`
            <tr>
              <td>${escapeHtml(t.tier_name ?? '')}</td>
              <td>${escapeHtml(t.applied_when ?? (t.min_quantity!=null?`>= ${t.min_quantity}`:''))}</td>
              <td>${t.price!=null ? money(t.price) : ''}</td>
            </tr>
          `).join('');
          return base + `
            <table>
              <thead><tr><th>Tier name</th><th>Applied when</th><th>Price</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
            <div class="muted">Volume-based: ${s.volume_based === true ? 'Yes' : s.volume_based === false ? 'No' : '—'}</div>
          `;
        }
        return base;
      }

      function toPlan(s){
        // Only include overage fields when billing type is not Flat price
        const base = {
          item_name: s.item_name,
          billing_type: s.billing_type,
          total_price: s.total_price ?? null,
          quantity: s.quantity ?? 1,
          start_date: s.start_date,
          months_of_service: s.months_of_service ?? null,
          frequency_every: s.frequency_every ?? 1,
          frequency_unit: s.frequency_unit ?? 'None',
          periods: s.periods ?? 1,
          net_terms: s.net_terms ?? 30,
          calculated_end_date: s.calculated_end_date ?? null,
          rev_rec_category: s.rev_rec_category ?? null
        };
        if (s.billing_type !== 'Flat price') {
          base.event_to_track = s.event_to_track ?? null;
          base.unit_label = s.unit_label ?? null;
          base.price_per_unit = s.price_per_unit ?? null;
          base.volume_based = s.volume_based ?? null;
          base.tiers = Array.isArray(s.tiers) ? s.tiers : [];
        }
        return base;
      }

      // ---------- helpers ----------
      function field(label, value){
        return `<div><label>${label}</label><input value="${value ?? ''}" readonly /></div>`;
      }
      function select(label, id, options, value){
        return `<div><label>${label}</label><select id="${id}" disabled>
          ${options.map(opt=>`<option ${opt===value?'selected':''}>${opt}</option>`).join('')}
        </select></div>`;
      }
      function money(n){ return `$${Number(n).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}` }
      function copyPlan(txt){ navigator.clipboard.writeText(txt).then(()=>alert('Copied! Paste into Garage.')); }
      function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
    </script>
  </body>
</html>
